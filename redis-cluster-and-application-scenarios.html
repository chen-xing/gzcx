<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>redis集群以及应用场景 | 主人翁</title>
    <meta property="og:title" content="redis集群以及应用场景 - 主人翁">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2022-03-15T21:55:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2022-03-15T21:55:00&#43;08:00'>
        
    <meta name="Keywords" content="工作总结、学习记录、心得体会、超越自我">
    <meta name="description" content="redis集群以及应用场景">
        
    <meta name="author" content="Mars">
    <meta property="og:url" content="https://www.cxztt.com/redis-cluster-and-application-scenarios.html">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
        <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://www.cxztt.com">
                        主人翁
                    </a>
                
                <p class="description">主人翁何在，你的选择是什么</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://www.cxztt.com">首页</a>
                    
                    <a  href="https://www.cxztt.com/tools/" title="工具">工具</a>
                    
                    <a  href="https://www.cxztt.com/archives/" title="归档">归档</a>
                    
                    <a  href="https://www.cxztt.com/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#集群">集群</a>
      <ul>
        <li><a href="#主从复制">主从复制</a></li>
        <li><a href="#哨兵机制">哨兵机制</a></li>
        <li><a href="#分布式集群cluster">分布式集群(Cluster)</a></li>
      </ul>
    </li>
    <li><a href="#使用场景">使用场景</a>
      <ul>
        <li><a href="#热点数据">热点数据</a></li>
        <li><a href="#会话维持-session">会话维持 Session</a></li>
        <li><a href="#分布式锁-setnx">分布式锁 SETNX</a></li>
        <li><a href="#表缓存">表缓存</a></li>
        <li><a href="#消息队列-list">消息队列 list</a></li>
        <li><a href="#计数器-string">计数器 string</a></li>
      </ul>
    </li>
    <li><a href="#缓存设计">缓存设计</a>
      <ul>
        <li><a href="#更新策略">更新策略</a></li>
        <li><a href="#更新一致性">更新一致性</a></li>
        <li><a href="#缓存粒度">缓存粒度</a></li>
        <li><a href="#缓存穿透">缓存穿透</a></li>
        <li><a href="#缓存雪崩">缓存雪崩</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if (leftPos < 220) {
                postToc.css({ "width": leftPos - 10, "margin-left": (0 - leftPos) })
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }

        if ($("#TableOfContents").children().length < 1) {
            $(".post-toc").remove();
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">redis集群以及应用场景</h1>
        </header>
        <date class="post-meta meta-date">
            2022年3月15日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%8E%89'>他山之玉</a></span>
            
        </div>
        
        
        
        <div class="clear" style="display: none">
            <div class="toc-article">
                <div class="toc-title">文章目录</div>
            </div>
        </div>
        
        <div class="post-content">
            <p>相关阅读：</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&amp;mid=2247484850&amp;idx=1&amp;sn=3238360bfa8105cf758dcf7354af2814&amp;chksm=cea24a79f9d5c36fb2399aafa91d7fb2699b5006d8d037fe8aaf2e5577ff20ae322868b04a87&amp;token=1082669959&amp;lang=zh_CN&amp;scene=21#wechat_redirect">史上最全Redis高可用技术解决方案大全</a></li>
<li><a href="http://weizijun.cn/2015/04/30/Raft%E5%8D%8F%E8%AE%AE%E5%AE%9E%E6%88%98%E4%B9%8BRedis%20Sentinel%E7%9A%84%E9%80%89%E4%B8%BELeader%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">Raft协议实战之Redis Sentinel的选举Leader源码解析</a></li>
</ul>
<p>目录：</p>
<!-- raw HTML omitted -->
<ul>
<li><a href="#redis-%E9%9B%86%E7%BE%A4%E4%BB%A5%E5%8F%8A%E5%BA%94%E7%94%A8">Redis 集群以及应用</a>
<ul>
<li><a href="#%E9%9B%86%E7%BE%A4">集群</a>
<ul>
<li><a href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6">主从复制</a>
<ul>
<li><a href="#%E4%B8%BB%E4%BB%8E%E9%93%BE%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84">主从链(拓扑结构)</a></li>
<li><a href="#%E5%A4%8D%E5%88%B6%E6%A8%A1%E5%BC%8F">复制模式</a></li>
<li><a href="#%E9%97%AE%E9%A2%98%E7%82%B9">问题点</a></li>
</ul>
</li>
<li><a href="#%E5%93%A8%E5%85%B5%E6%9C%BA%E5%88%B6">哨兵机制</a>
<ul>
<li><a href="#%E6%8B%93%E6%89%91%E5%9B%BE">拓扑图</a></li>
<li><a href="#%E8%8A%82%E7%82%B9%E4%B8%8B%E7%BA%BF">节点下线</a></li>
<li><a href="#Leader%E9%80%89%E4%B8%BE">Leader选举</a></li>
<li><a href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB">故障转移</a></li>
<li><a href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB">读写分离</a></li>
<li><a href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1">定时任务</a></li>
</ul>
</li>
<li><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4cluster">分布式集群(Cluster)</a>
<ul>
<li><a href="#%E6%8B%93%E6%89%91%E5%9B%BE">拓扑图</a></li>
<li><a href="#%E9%80%9A%E8%AE%AF">通讯</a>
<ul>
<li><a href="#%E9%9B%86%E4%B8%AD%E5%BC%8F">集中式</a></li>
<li><a href="#gossip">Gossip</a></li>
</ul>
</li>
<li><a href="#%E5%AF%BB%E5%9D%80%E5%88%86%E7%89%87">寻址分片</a>
<ul>
<li><a href="#hash%E5%8F%96%E6%A8%A1">hash取模</a></li>
<li><a href="#%E4%B8%80%E8%87%B4%E6%80%A7hash">一致性hash</a></li>
<li><a href="#hash%E6%A7%BD">hash槽</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">使用场景</a>
<ul>
<li><a href="#%E7%83%AD%E7%82%B9%E6%95%B0%E6%8D%AE">热点数据</a></li>
<li><a href="#%E4%BC%9A%E8%AF%9D%E7%BB%B4%E6%8C%81-session">会话维持 Session</a></li>
<li><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-setnx">分布式锁 SETNX</a></li>
<li><a href="#%E8%A1%A8%E7%BC%93%E5%AD%98">表缓存</a></li>
<li><a href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-list">消息队列 list</a></li>
<li><a href="#%E8%AE%A1%E6%95%B0%E5%99%A8-string">计数器 string</a></li>
</ul>
</li>
<li><a href="#%E7%BC%93%E5%AD%98%E8%AE%BE%E8%AE%A1">缓存设计</a>
<ul>
<li><a href="#%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5">更新策略</a></li>
<li><a href="#%E6%9B%B4%E6%96%B0%E4%B8%80%E8%87%B4%E6%80%A7">更新一致性</a></li>
<li><a href="#%E7%BC%93%E5%AD%98%E7%B2%92%E5%BA%A6">缓存粒度</a></li>
<li><a href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F">缓存穿透</a>
<ul>
<li><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">解决方案</a></li>
</ul>
</li>
<li><a href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9">缓存雪崩</a>
<ul>
<li><a href="#%E5%87%BA%E7%8E%B0%E5%90%8E%E5%BA%94%E5%AF%B9">出现后应对</a></li>
<li><a href="#%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B">请求过程</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="redis-集群以及应用">Redis 集群以及应用</h1>
<h2 id="集群">集群</h2>
<h3 id="主从复制">主从复制</h3>
<h4 id="主从链拓扑结构">主从链(拓扑结构)</h4>
<p>
        <a data-fancybox="gallery" href="https://user-images.githubusercontent.com/26766909/67539461-d1a26c00-f714-11e9-81ae-61fa89faf156.png">
            <img class="mx-auto" alt="主从" src="https://user-images.githubusercontent.com/26766909/67539461-d1a26c00-f714-11e9-81ae-61fa89faf156.png" />
        </a>
    </p>
<p>
        <a data-fancybox="gallery" href="https://user-images.githubusercontent.com/26766909/67539485-e0891e80-f714-11e9-8980-d253239fcd8b.png">
            <img class="mx-auto" alt="主从" src="https://user-images.githubusercontent.com/26766909/67539485-e0891e80-f714-11e9-8980-d253239fcd8b.png" />
        </a>
    </p>
<h4 id="复制模式">复制模式</h4>
<ul>
<li>全量复制：Master 全部同步到 Slave</li>
<li>部分复制：Slave 数据丢失进行备份</li>
</ul>
<h4 id="问题点">问题点</h4>
<ul>
<li>同步故障
<ul>
<li>复制数据延迟(不一致)</li>
<li>读取过期数据(Slave 不能删除数据)</li>
<li>从节点故障</li>
<li>主节点故障</li>
</ul>
</li>
<li>配置不一致
<ul>
<li>maxmemory 不一致:丢失数据</li>
<li>优化参数不一致:内存不一致.</li>
</ul>
</li>
<li>避免全量复制
<ul>
<li>选择小主节点(分片)、低峰期间操作.</li>
<li>如果节点运行 id 不匹配(如主节点重启、运行 id 发送变化)，此时要执行全量复制，应该配合哨兵和集群解决.</li>
<li>主从复制挤压缓冲区不足产生的问题(网络中断，部分复制无法满足)，可增大复制缓冲区( rel_backlog_size 参数).</li>
</ul>
</li>
<li>复制风暴</li>
</ul>
<h3 id="哨兵机制">哨兵机制</h3>
<h4 id="拓扑图">拓扑图</h4>
<p>
        <a data-fancybox="gallery" href="https://user-images.githubusercontent.com/26766909/67539495-f0086780-f714-11e9-9eab-c11a163ac6c0.png">
            <img class="mx-auto" alt="image" src="https://user-images.githubusercontent.com/26766909/67539495-f0086780-f714-11e9-9eab-c11a163ac6c0.png" />
        </a>
    </p>
<h4 id="节点下线">节点下线</h4>
<ul>
<li>主观下线
<ul>
<li>即 Sentinel 节点对 Redis 节点失败的偏见，超出超时时间认为 Master 已经宕机。</li>
<li>Sentinel 集群的每一个 Sentinel 节点会定时对 Redis 集群的所有节点发心跳包检测节点是否正常。如果一个节点在 <code>down-after-milliseconds</code> 时间内没有回复 Sentinel 节点的心跳包，则该 Redis 节点被该 Sentinel 节点主观下线。</li>
</ul>
</li>
<li>客观下线
<ul>
<li>所有 Sentinel 节点对 Redis 节点失败要达成共识，即超过 quorum 个统一。</li>
<li>当节点被一个 Sentinel 节点记为主观下线时，并不意味着该节点肯定故障了，还需要 Sentinel 集群的其他 Sentinel 节点共同判断为主观下线才行。</li>
<li>该 Sentinel 节点会询问其它 Sentinel 节点，如果 Sentinel 集群中超过 quorum 数量的 Sentinel 节点认为该 Redis 节点主观下线，则该 Redis 客观下线。</li>
</ul>
</li>
</ul>
<h4 id="leader选举">Leader选举</h4>
<ul>
<li>选举出一个 Sentinel 作为 Leader：集群中至少有三个 Sentinel 节点，但只有其中一个节点可完成故障转移.通过以下命令可以进行失败判定或领导者选举。</li>
<li>选举流程
<ol>
<li>每个主观下线的 Sentinel 节点向其他 Sentinel 节点发送命令，要求设置它为领导者.</li>
<li>收到命令的 Sentinel 节点如果没有同意通过其他 Sentinel 节点发送的命令，则同意该请求，否则拒绝。</li>
<li>如果该 Sentinel 节点发现自己的票数已经超过 Sentinel 集合半数且超过 quorum，则它成为领导者。</li>
<li>如果此过程有多个 Sentinel 节点成为领导者，则等待一段时间再重新进行选举。</li>
</ol>
</li>
</ul>
<h4 id="故障转移">故障转移</h4>
<ul>
<li>转移流程
<ol>
<li>Sentinel 选出一个合适的 Slave 作为新的 Master(slaveof no one 命令)。</li>
<li>向其余 Slave 发出通知，让它们成为新 Master 的 Slave( parallel-syncs 参数)。</li>
<li>等待旧 Master 复活，并使之称为新 Master 的 Slave。</li>
<li>向客户端通知 Master 变化。</li>
</ol>
</li>
<li>从 Slave 中选择新 Master 节点的规则(slave 升级成 master 之后)
<ol>
<li>选择 slave-priority 最高的节点。</li>
<li>选择复制偏移量最大的节点(同步数据最多)。</li>
<li>选择 runId 最小的节点。</li>
</ol>
</li>
</ul>
<blockquote>
<p>Sentinel 集群运行过程中故障转移完成，所有 Sentinel 又会恢复平等。Leader 仅仅是故障转移操作出现的角色。</p>
</blockquote>
<h4 id="读写分离">读写分离</h4>
<h4 id="定时任务">定时任务</h4>
<ul>
<li>每 1s 每个 Sentinel 对其他 Sentinel 和 Redis 执行 ping，进行心跳检测。</li>
<li>每 2s 每个 Sentinel 通过 Master 的 Channel 交换信息(pub - sub)。</li>
<li>每 10s 每个 Sentinel 对 Master 和 Slave 执行 info，目的是发现 Slave 节点、确定主从关系。</li>
</ul>
<h3 id="分布式集群cluster">分布式集群(Cluster)</h3>
<h4 id="拓扑图-1">拓扑图</h4>
<p>
        <a data-fancybox="gallery" href="https://user-images.githubusercontent.com/26766909/67539510-f8f93900-f714-11e9-9d8d-08afdecff95a.png">
            <img class="mx-auto" alt="image" src="https://user-images.githubusercontent.com/26766909/67539510-f8f93900-f714-11e9-9d8d-08afdecff95a.png" />
        </a>
    </p>
<h4 id="通讯">通讯</h4>
<h5 id="集中式">集中式</h5>
<blockquote>
<p>将集群元数据(节点信息、故障等等)几种存储在某个节点上。</p>
</blockquote>
<ul>
<li>优势
<ol>
<li>元数据的更新读取具有很强的时效性，元数据修改立即更新</li>
</ol>
</li>
<li>劣势
<ol>
<li>数据集中存储</li>
</ol>
</li>
</ul>
<h5 id="gossip">Gossip</h5>
<p>
        <a data-fancybox="gallery" href="https://user-images.githubusercontent.com/26766909/67539546-16c69e00-f715-11e9-9891-1e81b6af624c.png">
            <img class="mx-auto" alt="image" src="https://user-images.githubusercontent.com/26766909/67539546-16c69e00-f715-11e9-9891-1e81b6af624c.png" />
        </a>
    </p>
<ul>
<li><a href="https://www.jianshu.com/p/8279d6fd65bb">Gossip 协议</a></li>
</ul>
<h4 id="寻址分片">寻址分片</h4>
<h5 id="hash取模">hash取模</h5>
<ul>
<li>hash(key)%机器数量</li>
<li>问题
<ol>
<li>机器宕机，造成数据丢失，数据读取失败</li>
<li>伸缩性</li>
</ol>
</li>
</ul>
<h5 id="一致性hash">一致性hash</h5>
<ul>
<li>
<p>
        <a data-fancybox="gallery" href="https://user-images.githubusercontent.com/26766909/67539595-352c9980-f715-11e9-8e4a-9d9c04027785.png">
            <img class="mx-auto" alt="image" src="https://user-images.githubusercontent.com/26766909/67539595-352c9980-f715-11e9-8e4a-9d9c04027785.png" />
        </a>
    </p>
</li>
<li>
<p>问题</p>
<ol>
<li>一致性哈希算法在节点太少时，容易因为节点分布不均匀而造成缓存热点的问题。
<ul>
<li>解决方案
<ul>
<li>可以通过引入虚拟节点机制解决：即对每一个节点计算多个 hash，每个计算结果位置都放置一个虚拟节点。这样就实现了数据的均匀分布，负载均衡。</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<h5 id="hash槽">hash槽</h5>
<ul>
<li>CRC16(key)%16384</li>
<li></li>
</ul>
<h2 id="使用场景">使用场景</h2>
<h3 id="热点数据">热点数据</h3>
<p>存取数据优先从 Redis 操作，如果不存在再从文件（例如 MySQL）中操作，从文件操作完后将数据存储到 Redis 中并返回。同时有个定时任务后台定时扫描 Redis 的 key，根据业务规则进行淘汰，防止某些只访问一两次的数据一直存在 Redis 中。</p>
<blockquote>
<p>例如使用 Zset 数据结构，存储 Key 的访问次数/最后访问时间作为 Score，最后做排序，来淘汰那些最少访问的 Key。</p>
</blockquote>
<p>如果企业级应用，可以参考：<a href="https://promotion.aliyun.com/ntms/act/redishybridstorage.html?spm=5176.54432.1380373.5.41921cf20pcZrZ&amp;aly_as=ArH4VaEb">阿里云的 Redis 混合存储版</a></p>
<h3 id="会话维持-session">会话维持 Session</h3>
<p>会话维持 Session 场景，即使用 Redis 作为分布式场景下的登录中心存储应用。每次不同的服务在登录的时候，都会去统一的 Redis 去验证 Session 是否正确。但是在微服务场景，一般会考虑 Redis + JWT 做 Oauth2 模块。</p>
<blockquote>
<p>其中 Redis 存储 JWT 的相关信息主要是留出口子，方便以后做统一的防刷接口，或者做登录设备限制等。</p>
</blockquote>
<h3 id="分布式锁-setnx">分布式锁 SETNX</h3>
<p>命令格式：<code>SETNX key value</code>：当且仅当 key 不存在，将 key 的值设为 value。若给定的 key 已经存在，则 SETNX 不做任何动作。</p>
<ol>
<li>超时时间设置：获取锁的同时，启动守护线程，使用 expire 进行定时更新超时时间。如果该业务机器宕机，守护线程也挂掉，这样也会自动过期。如果该业务不是宕机，而是真的需要这么久的操作时间，那么增加超时时间在业务上也是可以接受的，但是肯定有个最大的阈值。</li>
<li>但是为了增加高可用，需要使用多台 Redis，就增加了复杂性，就可以参考 Redlock：<a href="Redlock%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81.md#%E6%80%8E%E4%B9%88%E5%9C%A8%E5%8D%95%E8%8A%82%E7%82%B9%E4%B8%8A%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81">Redlock分布式锁</a></li>
</ol>
<h3 id="表缓存">表缓存</h3>
<p>Redis 缓存表的场景有黑名单、禁言表等。访问频率较高，即读高。根据业务需求，可以使用后台定时任务定时刷新 Redis 的缓存表数据。</p>
<h3 id="消息队列-list">消息队列 list</h3>
<p>主要使用了 List 数据结构。<br>
List 支持在头部和尾部操作，因此可以实现简单的消息队列。</p>
<ol>
<li>发消息：在 List 尾部塞入数据。</li>
<li>消费消息：在 List 头部拿出数据。</li>
</ol>
<p>同时可以使用多个 List，来实现多个队列，根据不同的业务消息，塞入不同的 List，来增加吞吐量。</p>
<h3 id="计数器-string">计数器 string</h3>
<p>主要使用了 INCR、DECR、INCRBY、DECRBY 方法。</p>
<p>INCR key：给 key 的 value 值增加一
DECR key：给 key 的 value 值减去一</p>
<h2 id="缓存设计">缓存设计</h2>
<h3 id="更新策略">更新策略</h3>
<ul>
<li>LRU、LFU、FIFO 算法自动清除：一致性最差，维护成本低。</li>
<li>超时自动清除(key expire)：一致性较差，维护成本低。</li>
<li>主动更新：代码层面控制生命周期，一致性最好，维护成本高。</li>
</ul>
<p>在 Redis 根据在 redis.conf 的参数 <code>maxmemory</code> 来做更新淘汰策略：</p>
<ol>
<li>noeviction: 不删除策略, 达到最大内存限制时, 如果需要更多内存, 直接返回错误信息。大多数写命令都会导致占用更多的内存(有极少数会例外, 如 DEL 命令)。</li>
<li>allkeys-lru: 所有 key 通用; 优先删除最近最少使用(less recently used ,LRU) 的 key。</li>
<li>volatile-lru: 只限于设置了 expire 的部分; 优先删除最近最少使用(less recently used ,LRU) 的 key。</li>
<li>allkeys-random: 所有key通用; 随机删除一部分 key。</li>
<li>volatile-random: 只限于设置了 expire 的部分; 随机删除一部分 key。</li>
<li>volatile-ttl: 只限于设置了 expire 的部分; 优先删除剩余时间(time to live,TTL) 短的key。</li>
</ol>
<h3 id="更新一致性">更新一致性</h3>
<ul>
<li>读请求：先读缓存，缓存没有的话，就读数据库，然后取出数据后放入缓存，同时返回响应。</li>
<li>写请求：先删除缓存，然后再更新数据库(避免大量地写、却又不经常读的数据导致缓存频繁更新)。</li>
</ul>
<h3 id="缓存粒度">缓存粒度</h3>
<ul>
<li>通用性：全量属性更好。</li>
<li>占用空间：部分属性更好。</li>
<li>代码维护成本。</li>
</ul>
<h3 id="缓存穿透">缓存穿透</h3>
<blockquote>
<p>当大量的请求无命中缓存、直接请求到后端数据库(业务代码的 bug、或恶意攻击)，同时后端数据库也没有查询到相应的记录、无法添加缓存。<br>
这种状态会一直维持，流量一直打到存储层上，无法利用缓存、还会给存储层带来巨大压力。</p>
</blockquote>
<h4 id="解决方案">解决方案</h4>
<ol>
<li>请求无法命中缓存、同时数据库记录为空时在缓存添加该 key 的空对象(设置过期时间)，缺点是可能会在缓存中添加大量的空值键(比如遭到恶意攻击或爬虫)，而且缓存层和存储层数据短期内不一致；</li>
<li>使用布隆过滤器在缓存层前拦截非法请求、自动为空值添加黑名单(同时可能要为误判的记录添加白名单).但需要考虑布隆过滤器的维护(离线生成/ 实时生成)。</li>
</ol>
<h3 id="缓存雪崩">缓存雪崩</h3>
<blockquote>
<p>缓存崩溃时请求会直接落到数据库上，很可能由于无法承受大量的并发请求而崩溃，此时如果只重启数据库，或因为缓存重启后没有数据，新的流量进来很快又会把数据库击倒。</p>
</blockquote>
<h4 id="出现后应对">出现后应对</h4>
<ul>
<li>事前：Redis 高可用，主从 + 哨兵，Redis Cluster，避免全盘崩溃。</li>
<li>事中：本地 ehcache 缓存 + hystrix 限流 &amp; 降级，避免数据库承受太多压力。</li>
<li>事后：Redis 持久化，一旦重启，自动从磁盘上加载数据，快速恢复缓存数据。</li>
</ul>
<h4 id="请求过程">请求过程</h4>
<ol>
<li>用户请求先访问本地缓存，无命中后再访问 Redis，如果本地缓存和 Redis 都没有再查数据库，并把数据添加到本地缓存和 Redis；</li>
<li>由于设置了限流，一段时间范围内超出的请求走降级处理(返回默认值，或给出友情提示)。</li>
</ol>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="https://www.cxztt.com">Mars</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="https://www.cxztt.com/redis-cluster-and-application-scenarios.html">https://www.cxztt.com/redis-cluster-and-application-scenarios.html</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。本站为<a href="https://www.94rg.com/">人工博客</a></li>的子站点。内容均来自主站。
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/2019alipay-pinduoduo-toutiao.html">2019alipay-pinduoduo-toutiao</a></li>
        
        <li><a href="/5-faces-Ali,-finally-got-the-offer.html">5面阿里,终获offer</a></li>
        
        <li><a href="/AQS.html">AQS</a></li>
        
        <li><a href="/ArrayList.html">ArrayList</a></li>
        
        <li><a href="/ArrayList-Grow.html">ArrayList-Grow</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%8E%89'>他山之玉</a></li>
                
            </ul>
            
        </div>
    </article>
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yourdiscussshortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "chen-xing/PgHugo"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2022 <a href="https://www.cxztt.com">主人翁 By Mars</a>
        
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>






    <script src='/js/douban.js'></script>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://www.cxztt.com/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://www.cxztt.com">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://www.cxztt.com/2019alipay-pinduoduo-toutiao.html" title="2019alipay-pinduoduo-toutiao">2019alipay-pinduoduo-toutiao</a>
    </li>
    
    <li>
        <a href="https://www.cxztt.com/2020-Programmer%27s-Day-Summary---How-to-Realize-Self-worth.html" title="2020程序员节总结-如何实现自我价值">2020程序员节总结-如何实现自我价值</a>
    </li>
    
    <li>
        <a href="https://www.cxztt.com/5-faces-Ali,-finally-got-the-offer.html" title="5面阿里,终获offer">5面阿里,终获offer</a>
    </li>
    
    <li>
        <a href="https://www.cxztt.com/alibaba-1.html" title="alibaba-1">alibaba-1</a>
    </li>
    
    <li>
        <a href="https://www.cxztt.com/AOP-joint-reflection-realizes-read-and-write-switching-between-mysql-and-hbase.html" title="aop联合反射实现mysql与hbase的读写切换">aop联合反射实现mysql与hbase的读写切换</a>
    </li>
    
    <li>
        <a href="https://www.cxztt.com/AQS.html" title="AQS">AQS</a>
    </li>
    
    <li>
        <a href="https://www.cxztt.com/ArrayList.html" title="ArrayList">ArrayList</a>
    </li>
    
    <li>
        <a href="https://www.cxztt.com/ArrayList-Grow.html" title="ArrayList-Grow">ArrayList-Grow</a>
    </li>
    
    <li>
        <a href="https://www.cxztt.com/Arrays,-CollectionsCommonMethods.html" title="Arrays,CollectionsCommonMethods">Arrays,CollectionsCommonMethods</a>
    </li>
    
    <li>
        <a href="https://www.cxztt.com/Arthas-User-Guide.html" title="Arthas使用指南">Arthas使用指南</a>
    </li>
    
</ul>
    </section>

    
<section class="widget">
    <h3 class="widget-title" style="color:red">福利派送</h3>
    <ul class="widget-list">
        
        <li>
            <a href="https://www.aliyun.com/minisite/goods?userCode=jdg9oj97&amp;share_source=copy_link" title="pan gun running" target="_blank" style="color:red">
                
                    <img src="/images/banner.png">
                
            </a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://www.cxztt.com/categories/Java/">Java (3)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/linux/">linux (7)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/Spring/">Spring (3)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/Spring-Boot/">Spring Boot (5)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/Tool/">Tool (11)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/blog/">blog (6)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/healthy/">healthy (1)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/http/">http (3)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/Java/">Java (38)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/linux/">linux (1)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/postman/">postman (3)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/seo/">seo (2)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/swing/">swing (1)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/thinking/">thinking (1)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/Tool/">Tool (2)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E4%B9%98%E9%A3%8E%E7%A0%B4%E6%B5%AA/">乘风破浪 (5)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%8E%89/">他山之玉 (80)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5/">代码片段 (2)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E5%89%8D%E7%AB%AF/">前端 (1)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">基础知识 (2)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E5%AE%89%E5%85%A8/">安全 (2)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E5%B7%A5%E5%85%B7/">工具 (33)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E6%85%A2%E7%94%9F%E6%B4%BB/">慢生活 (1)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E6%95%85%E9%9A%9C%E5%AE%9A%E4%BD%8D/">故障定位 (4)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/">数字签名 (1)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 (1)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E7%AB%99%E9%95%BF/">站长 (20)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E7%BB%8F%E6%B5%8E%E5%AD%A6/">经济学 (1)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E7%BB%8F%E9%AA%8C/">经验 (14)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 (1)</a></li>
    
    <li><a href="https://www.cxztt.com/categories/%E8%BF%90%E7%BB%B4/">运维 (5)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://www.cxztt.com/tags/linux/">linux</a>
    
    <a href="https://www.cxztt.com/tags/Spring/">Spring</a>
    
    <a href="https://www.cxztt.com/tags/Spring-Boot/">Spring Boot</a>
    
    <a href="https://www.cxztt.com/tags/blog/">blog</a>
    
    <a href="https://www.cxztt.com/tags/freemarker/">freemarker</a>
    
    <a href="https://www.cxztt.com/tags/git/">git</a>
    
    <a href="https://www.cxztt.com/tags/http/">http</a>
    
    <a href="https://www.cxztt.com/tags/idea/">idea</a>
    
    <a href="https://www.cxztt.com/tags/java/">java</a>
    
    <a href="https://www.cxztt.com/tags/linux/">linux</a>
    
    <a href="https://www.cxztt.com/tags/markdown/">markdown</a>
    
    <a href="https://www.cxztt.com/tags/postman/">postman</a>
    
    <a href="https://www.cxztt.com/tags/seo/">seo</a>
    
    <a href="https://www.cxztt.com/tags/sports/">sports</a>
    
    <a href="https://www.cxztt.com/tags/swing/">swing</a>
    
    <a href="https://www.cxztt.com/tags/tool/">tool</a>
    
    <a href="https://www.cxztt.com/tags/zuul/">zuul</a>
    
    <a href="https://www.cxztt.com/tags/%E4%B9%98%E9%A3%8E%E7%A0%B4%E6%B5%AA/">乘风破浪</a>
    
    <a href="https://www.cxztt.com/tags/%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%8E%89/">他山之玉</a>
    
    <a href="https://www.cxztt.com/tags/%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5/">代码片段</a>
    
    <a href="https://www.cxztt.com/tags/%E5%89%8D%E7%AB%AF/">前端</a>
    
    <a href="https://www.cxztt.com/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">基础知识</a>
    
    <a href="https://www.cxztt.com/tags/%E5%AE%89%E5%85%A8/">安全</a>
    
    <a href="https://www.cxztt.com/tags/%E5%B7%A5%E5%85%B7/">工具</a>
    
    <a href="https://www.cxztt.com/tags/%E6%85%A2%E7%94%9F%E6%B4%BB/">慢生活</a>
    
    <a href="https://www.cxztt.com/tags/%E6%95%85%E9%9A%9C%E5%AE%9A%E4%BD%8D/">故障定位</a>
    
    <a href="https://www.cxztt.com/tags/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/">数字签名</a>
    
    <a href="https://www.cxztt.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
    
    <a href="https://www.cxztt.com/tags/%E7%AB%99%E9%95%BF/">站长</a>
    
    <a href="https://www.cxztt.com/tags/%E7%BB%8F%E6%B5%8E%E5%AD%A6/">经济学</a>
    
    <a href="https://www.cxztt.com/tags/%E7%BB%8F%E9%AA%8C/">经验</a>
    
    <a href="https://www.cxztt.com/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a>
    
    <a href="https://www.cxztt.com/tags/%E8%BF%90%E7%BB%B4/">运维</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://www.94rg.com/" title="人工博客">人工博客</a>
        </li>
        
        <li>
            <a target="_blank" href="https://www.chenzhuofan.top" title="程序员导航网，便于程序员日常使用的网址集合，你想要的都在这里☺">程序员导航网</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://www.cxztt.com/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>